 const obtenerCategoriasPrincipales = asyncHandler(async (req, res) => {
  const incluirPosts = req.query.posts === 'true';
  const ahora = Date.now();

  // ðŸ”¹ CachÃ© solo para nivel 1 sin posts
  if (!incluirPosts && cacheCategoriasPrincipales && ahora - cacheCategoriasPrincipalesEn < 5 * 60 * 1000) {
    return res.json(cacheCategoriasPrincipales);
  }

  // 1ï¸âƒ£ Traer categorÃ­as activas
  const [nivel1, nivel2, nivel3] = await Promise.all([
    Category.find({ level: 1, isActive: true })
      .select('_id name slug icon emoji order hasChildren postCount')
      .sort({ order: 1 })
      .lean(),
    Category.find({ level: 2, isActive: true })
      .select('_id name slug parent emoji order hasChildren isLeaf')
      .sort({ order: 1 })
      .lean(),
    Category.find({ level: 3, isActive: true })
      .select('_id name slug parent emoji order isLeaf')
      .sort({ order: 1 })
      .lean(),
  ]);

  // 2ï¸âƒ£ Armar relaciones padre-hijo en memoria
  const nivel3PorPadre = {};
  nivel3.forEach(cat => {
    const idPadre = String(cat.parent);
    if (!nivel3PorPadre[idPadre]) nivel3PorPadre[idPadre] = [];
    nivel3PorPadre[idPadre].push(cat);
  });

  nivel2.forEach(subcat => {
    const clave = String(subcat._id);
    subcat.children = nivel3PorPadre[clave] || [];
    subcat.hasChildren = subcat.children.length > 0;
  });

  const nivel2PorPadre = {};
  nivel2.forEach(subcat => {
    const idPadre = String(subcat.parent);
    if (!nivel2PorPadre[idPadre]) nivel2PorPadre[idPadre] = [];
    nivel2PorPadre[idPadre].push(subcat);
  });

  nivel1.forEach(cat => {
    const clave = String(cat._id);
    cat.children = nivel2PorPadre[clave] || [];
    cat.hasChildren = cat.children.length > 0;
  });

  // 3ï¸âƒ£ Traer posts si se piden
  if (incluirPosts) {
    // Crear lista de todos los ids de categorÃ­as (nivel1, nivel2, nivel3)
    const todosIds = [
      ...nivel1.map(c => c._id),
      ...nivel2.map(c => c._id),
      ...nivel3.map(c => c._id),
    ];

    // ðŸ”¹ UNA SOLA CONSULTA a Post
    const posts = await Post.find({ category: { $in: todosIds }, status: 'active' })
      .select('_id title price images createdAt location category')
      .sort({ createdAt: -1 })
      .lean();

    // ðŸ”¹ Map para asignar posts a su categorÃ­a
    const postsMap = {};
    posts.forEach(post => {
      const key = String(post.category);
      if (!postsMap[key]) postsMap[key] = [];
      if (postsMap[key].length < 8) postsMap[key].push(post); // limitar a 8 por categorÃ­a
    });

    // ðŸ”¹ Asignar posts a nivel3
    nivel3.forEach(cat => {
      cat.posts = postsMap[String(cat._id)] || [];
    });

    // ðŸ”¹ Asignar posts a nivel2 sumando hijos nivel3
    nivel2.forEach(cat => {
      const hijosPosts = cat.children.flatMap(c => c.posts || []);
      cat.posts = [...(postsMap[String(cat._id)] || []), ...hijosPosts].slice(0, 8);
    });

    // ðŸ”¹ Asignar posts a nivel1 sumando hijos nivel2
    nivel1.forEach(cat => {
      const hijosPosts = cat.children.flatMap(c => c.posts || []);
      cat.posts = [...(postsMap[String(cat._id)] || []), ...hijosPosts].slice(0, 8);
    });
  }

  const respuesta = { success: true, categories: nivel1 };

  // ðŸ”¹ Guardar cachÃ© si no se piden posts
  if (!incluirPosts) {
    cacheCategoriasPrincipales = respuesta;
    cacheCategoriasPrincipalesEn = ahora;
  }

  return res.json(respuesta);
});

