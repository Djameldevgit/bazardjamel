// ðŸ“‚ backend/routes/post.js - Agregar estas rutas de debug
const express = require('express');
const router = express.Router();
const Post = require('../models/Post');
const Category = require('../models/Category');

// âœ… RUTA DE DIAGNÃ“STICO (sin auth)
router.post('/debug-create', async (req, res) => {
  try {
    console.log('ðŸ”§ ======= DEBUG CREATE POST =======');
    console.log('ðŸ“¦ Request body:', JSON.stringify(req.body, null, 2));
    console.log('ðŸ“¨ Headers:', req.headers);
    
    // Datos mÃ­nimos para prueba
    const { title, description, price, categorie, subCategory } = req.body;
    
    if (!title || !description || !price) {
      return res.status(400).json({
        success: false,
        msg: 'Faltan campos requeridos'
      });
    }
    
    // Buscar cualquier categorÃ­a disponible
    const randomCategory = await Category.findOne({ isActive: true });
    
    if (!randomCategory) {
      return res.status(404).json({
        success: false,
        msg: 'No hay categorÃ­as en la base de datos'
      });
    }
    
    console.log('âœ… CategorÃ­a encontrada:', randomCategory.name);
    
    // Crear post simple
    const postData = {
      title: title.substring(0, 100), // Limitar longitud
      description: description.substring(0, 500),
      price: parseFloat(price) || 0,
      category: randomCategory._id,
      user: req.body.user || '65d8f1a2e4b0c4a9c8f1a2b3', // ID temporal
      images: req.body.images || [],
      status: 'active'
    };
    
    console.log('ðŸ“¤ Datos para crear post:', postData);
    
    const post = new Post(postData);
    const savedPost = await post.save();
    
    console.log('âœ… Post creado exitosamente:', savedPost._id);
    
    res.status(201).json({
      success: true,
      msg: 'Post creado en modo debug',
      post: savedPost
    });
    
  } catch (error) {
    console.error('âŒ ERROR en debug-create:', {
      message: error.message,
      name: error.name,
      code: error.code,
      stack: error.stack
    });
    
    // Si es error de validaciÃ³n de Mongoose
    if (error.name === 'ValidationError') {
      const errors = {};
      Object.keys(error.errors).forEach(key => {
        errors[key] = error.errors[key].message;
      });
      
      return res.status(400).json({
        success: false,
        msg: 'Error de validaciÃ³n',
        errors
      });
    }
    
    // Si es error de MongoDB
    if (error.name === 'MongoError' || error.code === 11000) {
      return res.status(400).json({
        success: false,
        msg: 'Error de base de datos',
        error: error.message
      });
    }
    
    res.status(500).json({
      success: false,
      msg: 'Error interno del servidor',
      error: error.message,
      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

// âœ… RUTA PARA VER ESTADO DEL SERVIDOR
router.get('/health', (req, res) => {
  console.log('ðŸ©º Health check ejecutado');
  res.json({
    success: true,
    msg: 'Servidor funcionando',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

// âœ… RUTA PARA VER MODELO POST
router.get('/model-info', (req, res) => {
  try {
    const schemaPaths = Post.schema.paths;
    const requiredFields = [];
    const fields = [];
    
    Object.keys(schemaPaths).forEach(key => {
      const path = schemaPaths[key];
      fields.push({
        field: key,
        type: path.instance,
        required: path.isRequired || false,
        default: path.defaultValue
      });
      
      if (path.isRequired) {
        requiredFields.push(key);
      }
    });
    
    res.json({
      success: true,
      model: 'Post',
      requiredFields,
      totalFields: fields.length,
      fields
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      msg: 'Error obteniendo info del modelo',
      error: error.message
    });
  }
});

module.exports = router;